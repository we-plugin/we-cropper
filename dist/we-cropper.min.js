/**
 * we-cropper v1.2.0
 * (c) 2018 dlhandsome
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.WeCropper=t()}(this,function(){"use strict";var o=void 0,t=["touchstarted","touchmoved","touchended"];function f(e){return"function"==typeof e}function r(o){for(var n=[],e=arguments.length-1;0<e--;)n[e]=arguments[e+1];t.forEach(function(e,t){void 0!==n[t]&&(o[e]=n[t])})}var n={},a={id:{default:"cropper",get:function(){return n.id},set:function(e){"string"!=typeof e&&console.error("id\uff1a"+e+" is invalid"),n.id=e}},width:{default:750,get:function(){return n.width},set:function(e){"number"!=typeof e&&console.error("width\uff1a"+e+" is invalid"),n.width=e}},height:{default:750,get:function(){return n.height},set:function(e){"number"!=typeof e&&console.error("height\uff1a"+e+" is invalid"),n.height=e}},scale:{default:2.5,get:function(){return n.scale},set:function(e){"number"!=typeof e&&console.error("scale\uff1a"+e+" is invalid"),n.scale=e}},zoom:{default:5,get:function(){return n.zoom},set:function(e){"number"!=typeof e?console.error("zoom\uff1a"+e+" is invalid"):(e<0||10<e)&&console.error("zoom should be ranged in 0 ~ 10"),n.zoom=e}},src:{default:"cropper",get:function(){return n.src},set:function(e){"string"!=typeof e&&console.error("id\uff1a"+e+" is invalid"),n.src=e}},cut:{default:{},get:function(){return n.cut},set:function(e){"object"!=typeof e&&console.error("id\uff1a"+e+" is invalid"),n.cut=e}},inRealTime:{default:!0,get:function(){return n.inRealTime},set:function(e){"boolean"!=typeof e&&console.error("inRealTime:"+e+" is invalid"),n.inRealTime=e}},onReady:{default:null,get:function(){return n.ready},set:function(e){n.ready=e}},onBeforeImageLoad:{default:null,get:function(){return n.beforeImageLoad},set:function(e){n.beforeImageLoad=e}},onImageLoad:{default:null,get:function(){return n.imageLoad},set:function(e){n.imageLoad=e}},onBeforeDraw:{default:null,get:function(){return n.beforeDraw},set:function(e){n.beforeDraw=e}}};var l="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var e,i=(function(u,h){!function(e){var t=h,o=u&&u.exports==t&&u,n="object"==typeof l&&l;n.global!==n&&n.window!==n||(e=n);var r=function(e){this.message=e};(r.prototype=new Error).name="InvalidCharacterError";var d=function(e){throw new r(e)},s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c=/[\t\n\f\r ]/g,a={encode:function(e){e=String(e),/[^\0-\xFF]/.test(e)&&d("The string to be encoded contains characters outside of the Latin1 range.");for(var t,o,n,r,a=e.length%3,i="",c=-1,u=e.length-a;++c<u;)t=e.charCodeAt(c)<<16,o=e.charCodeAt(++c)<<8,n=e.charCodeAt(++c),i+=s.charAt((r=t+o+n)>>18&63)+s.charAt(r>>12&63)+s.charAt(r>>6&63)+s.charAt(63&r);return 2==a?(t=e.charCodeAt(c)<<8,o=e.charCodeAt(++c),i+=s.charAt((r=t+o)>>10)+s.charAt(r>>4&63)+s.charAt(r<<2&63)+"="):1==a&&(r=e.charCodeAt(c),i+=s.charAt(r>>2)+s.charAt(r<<4&63)+"=="),i},decode:function(e){var t=(e=String(e).replace(c,"")).length;t%4==0&&(t=(e=e.replace(/==?$/,"")).length),(t%4==1||/[^+a-zA-Z0-9/]/.test(e))&&d("Invalid character: the string to be decoded is not correctly encoded.");for(var o,n,r=0,a="",i=-1;++i<t;)n=s.indexOf(e.charAt(i)),o=r%4?64*o+n:n,r++%4&&(a+=String.fromCharCode(255&o>>(-2*r&6)));return a},version:"0.1.0"};if(t&&!t.nodeType)if(o)o.exports=a;else for(var i in a)a.hasOwnProperty(i)&&(t[i]=a[i]);else e.base64=a}(l)}(e={exports:{}},e.exports),e.exports);function y(e){var t="";if("string"==typeof e)t=e;else for(var o=0;o<e.length;o++)t+=String.fromCharCode(e[o]);return i.encode(t)}function c(e,t,o,n,r,a,i){var c,u,d,s,h,l;void 0===i&&(i=function(){}),void 0===a&&(a="png"),a="image/"+a.toLowerCase().replace(/jpg/i,"jpeg").match(/png|jpeg|bmp|gif/)[0],/bmp/.test(a)?(c=e,u=t,d=o,s=n,h=r,l=function(e){var t=function(e){var t=e.width,o=e.height,n=t*o*3,r=n+54,a=[66,77,255&r,r>>8&255,r>>16&255,r>>24&255,0,0,0,0,54,0,0,0],i=[40,0,0,0,255&t,t>>8&255,t>>16&255,t>>24&255,255&o,o>>8&255,o>>16&255,o>>24&255,1,0,24,0,0,0,0,0,255&n,n>>8&255,n>>16&255,n>>24&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],c=(4-3*t%4)%4,u=e.data,d="",s=t<<2,h=o,l=String.fromCharCode;do{for(var f=s*(h-1),g="",p=0;p<t;p++){var v=p<<2;g+=l(u[f+v+2])+l(u[f+v+1])+l(u[f+v])}for(var m=0;m<c;m++)g+=String.fromCharCode(0);d+=g}while(--h);return y(a.concat(i))+y(d)}(e);f(i)&&i("data:"+("image/"+a)+";base64,"+t)},wx.canvasGetImageData({canvasId:c,x:u,y:d,width:s,height:h,success:function(e){l(e)},fail:function(e){l(null),console.error("canvasGetImageData error: "+e)}})):console.error("\u6682\u4e0d\u652f\u6301\u751f\u6210'"+a+"'\u7c7b\u578b\u7684base64\u56fe\u7247")}var g={convertToImage:c,convertToBMP:function(e,t){return void 0===e&&(e={}),void 0===t&&(t=function(){}),c(e.canvasId,e.x,e.y,e.width,e.height,"bmp",t)}};var d=function(e,t,o,n,r){var a,i;return a=Math.round(r.x-n.x),i=Math.round(r.y-n.y),e+.001*o*(Math.round(Math.sqrt(a*a+i*i))-t)};var u={touchStart:function(e){var t=e.touches,o=t[0],n=t[1];r(this,!0,null,null),this.__oneTouchStart(o),2<=e.touches.length&&this.__twoTouchStart(o,n)},touchMove:function(e){var t=e.touches,o=t[0],n=t[1];r(this,null,!0),1===e.touches.length&&this.__oneTouchMove(o),2<=e.touches.length&&this.__twoTouchMove(o,n)},touchEnd:function(e){r(this,!1,!1,!0),this.__xtouchEnd()}};var s=function(e){var t,o,n=this,r={};return t=n,o=a,Object.defineProperties(t,o),Object.keys(a).forEach(function(e){r[e]=a[e].default}),Object.assign(n,r,e),n.prepare(),n.attachPage(),n.createCtx(),n.observer(),n.cutt(),n.methods(),n.init(),n.update(),n};return s.prototype.init=function(){var e=this,t=e.src;return e.version="1.2.0","function"==typeof e.onReady&&e.onReady(e.ctx,e),t&&e.pushOrign(t),r(e,!1,!1,!1),e.oldScale=1,e.newScale=1,e},Object.assign(s.prototype,u),s.prototype.prepare=function(){var t=this,e=(o||(o=wx.getSystemInfoSync()),o).windowWidth;t.attachPage=function(){var e=getCurrentPages();e[e.length-1].wecropper=t},t.createCtx=function(){var e=t.id;e?t.ctx=wx.createCanvasContext(e):console.error("constructor: create canvas context failed, 'id' must be valuable")},t.deviceRadio=e/750},s.prototype.observer=function(){var n=this,r=["ready","beforeImageLoad","beforeDraw","imageLoad"];n.on=function(e,t){var o;return-1<r.indexOf(e)?"function"==typeof t&&("ready"===e?t(n):n["on"+(o=e,o.charAt(0).toUpperCase()+o.slice(1))]=t):console.error("event: "+e+" is invalid"),n}},s.prototype.methods=function(){var a=this,i=a.id,c=a.deviceRadio,e=a.width,t=a.height,o=a.cut,u=o.x;void 0===u&&(u=0);var d=o.y;void 0===d&&(d=0);var s=o.width;void 0===s&&(s=e);var h=o.height;void 0===h&&(h=t),a.updateCanvas=function(){return a.croperTarget&&a.ctx.drawImage(a.croperTarget,a.imgLeft,a.imgTop,a.scaleWidth,a.scaleHeight),f(a.onBeforeDraw)&&a.onBeforeDraw(a.ctx,a),a.setBoundStyle(),a.ctx.draw(),a},a.updateImage=function(e){if(void 0===e&&(e=!1),a.croperTarget&&e&&a.pageContext.setData({"cropperOpt.cropperImageSrc":a.croperTarget}),a.imgLeft&&a.imgTop)return a.pageContext.setData({"cropperOpt.imageLeft":a.imgLeft,"cropperOpt.imageTop":a.imgTop,"cropperOpt.imageWidth":a.scaleWidth,"cropperOpt.imageHeight":a.scaleHeight}),a},a.pushOrign=function(e){return a.src=e,f(a.onBeforeImageLoad)&&a.onBeforeImageLoad(a.ctx,a),wx.getImageInfo({src:e,success:function(e){var t=e.width/e.height;a.croperTarget=e.path,t<s/h?(a.rectX=u,a.baseWidth=s,a.baseHeight=s/t,a.rectY=d-Math.abs((h-a.baseHeight)/2)):(a.rectY=d,a.baseWidth=h*t,a.baseHeight=h,a.rectX=u-Math.abs((s-a.baseWidth)/2)),a.imgLeft=a.rectX,a.imgTop=a.rectY,a.scaleWidth=a.baseWidth,a.scaleHeight=a.baseHeight,a.inRealTime?a.updateCanvas():a.updateImage(!0),f(a.onImageLoad)&&a.onImageLoad(a.ctx,a)}}),a.update(),a},a.getCropperBase64=function(e){void 0===e&&(e=function(){}),g.convertToBMP({canvasId:i,x:u,y:d,width:s,height:h},e)},a.getCropperImage=function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];a.updateCanvas();var o=toString.call(e[0]),n=e[e.length-1];switch(o){case"[object Object]":var r=e[0].quality;void 0===r&&(r=10),"number"!=typeof r?console.error("quality\uff1a"+r+" is invalid"):(r<0||10<r)&&console.error("quality should be ranged in 0 ~ 10"),wx.canvasToTempFilePath({canvasId:i,x:u,y:d,width:s,height:h,destWidth:s*r/(10*c),destHeight:h*r/(10*c),success:function(e){f(n)&&n.call(a,e.tempFilePath)},fail:function(e){f(n)&&n.call(a,null)}});break;case"[object Function]":wx.canvasToTempFilePath({canvasId:i,x:u,y:d,width:s,height:h,destWidth:s/c,destHeight:h/c,success:function(e){f(n)&&n.call(a,e.tempFilePath)},fail:function(e){f(n)&&n.call(a,null)}})}return a}},s.prototype.cutt=function(){var a=this,i=a.width,c=a.height,e=a.cut,u=e.x;void 0===u&&(u=0);var d=e.y;void 0===d&&(d=0);var s=e.width;void 0===s&&(s=i);var h=e.height;void 0===h&&(h=c),a.outsideBound=function(e,t){a.imgLeft=u<=e?u:a.scaleWidth+e-u<=s?u+s-a.scaleWidth:e,a.imgTop=d<=t?d:a.scaleHeight+t-d<=h?d+h-a.scaleHeight:t},a.setBoundStyle=function(e){void 0===e&&(e={});var t=e.color;void 0===t&&(t="#04b00f");var o=e.mask;void 0===o&&(o="rgba(0, 0, 0, 0.3)");var n=e.lineWidth;void 0===n&&(n=1);var r=[{start:{x:u-n,y:d+10-n},step1:{x:u-n,y:d-n},step2:{x:u+10-n,y:d-n}},{start:{x:u-n,y:d+h-10+n},step1:{x:u-n,y:d+h+n},step2:{x:u+10-n,y:d+h+n}},{start:{x:u+s-10+n,y:d-n},step1:{x:u+s+n,y:d-n},step2:{x:u+s+n,y:d+10-n}},{start:{x:u+s+n,y:d+h-10+n},step1:{x:u+s+n,y:d+h+n},step2:{x:u+s-10+n,y:d+h+n}}];a.ctx.beginPath(),a.ctx.setFillStyle(o),a.ctx.fillRect(0,0,u,c),a.ctx.fillRect(u,0,s,d),a.ctx.fillRect(u,d+h,s,c-d-h),a.ctx.fillRect(u+s,0,i-u-s,c),a.ctx.fill(),r.forEach(function(e){a.ctx.beginPath(),a.ctx.setStrokeStyle(t),a.ctx.setLineWidth(n),a.ctx.moveTo(e.start.x,e.start.y),a.ctx.lineTo(e.step1.x,e.step1.y),a.ctx.lineTo(e.step2.x,e.step2.y),a.ctx.stroke()})}},s.prototype.update=function(){var u=this;u.src&&(u.__oneTouchStart=function(e){u.touchX0=Math.round(e.x),u.touchY0=Math.round(e.y)},u.__oneTouchMove=function(e){var t,o;if(u.touchended)return u.inRealTime||u.updateImage(),u.updateCanvas();t=Math.round(e.x-u.touchX0),o=Math.round(e.y-u.touchY0);var n=Math.round(u.rectX+t),r=Math.round(u.rectY+o);u.outsideBound(n,r),u.inRealTime?u.updateCanvas():u.updateImage()},u.__twoTouchStart=function(e,t){var o,n,r;u.touchX1=Math.round(u.rectX+u.scaleWidth/2),u.touchY1=Math.round(u.rectY+u.scaleHeight/2),o=Math.round(t.x-e.x),n=Math.round(t.y-e.y),r=Math.round(Math.sqrt(o*o+n*n)),u.oldDistance=r},u.__twoTouchMove=function(e,t){var o=u.oldScale,n=u.oldDistance,r=u.scale,a=u.zoom;u.newScale=d(o,n,a,e,t),u.newScale<=1&&(u.newScale=1),u.newScale>=r&&(u.newScale=r),u.scaleWidth=Math.round(u.newScale*u.baseWidth),u.scaleHeight=Math.round(u.newScale*u.baseHeight);var i=Math.round(u.touchX1-u.scaleWidth/2),c=Math.round(u.touchY1-u.scaleHeight/2);u.outsideBound(i,c),u.inRealTime?u.updateCanvas():u.updateImage()},u.__xtouchEnd=function(){u.oldScale=u.newScale,u.rectX=u.imgLeft,u.rectY=u.imgTop})},s});